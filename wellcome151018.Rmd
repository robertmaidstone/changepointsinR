---
title: "Changepoint Analysis Using R"
author: "Robert Maidstone"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  beamer_presentation:
      includes:
        in_header: ~/changepointsinR/header-beamer.tex
        keep_tex: yes
---



## What are Changepoints?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE,message=FALSE)
library(tidyverse)
library(patchwork)
```



## Change in mean

\begincols
  \begincol{.6\textwidth}
<!-- \footnotesize -->
\scriptsize
```{r,echo=TRUE}
set.seed(14)
m<-5
n<-1000
true_cps <- c(0,sort(sample(1:(n-1),m)),n)
means <- rnorm(m+1,0,4)
y<-c()
for(i in 1:(m+1)){
  j <- (true_cps[i]+1):true_cps[i+1]
  y[j]<-rnorm(length(j),means[i],1)
}

```
  \endcol
\begincol{.4\textwidth}
```{r pressure, fig.height=4,fig.width=3}
ggplot(data.frame(x=1:n,y=y),aes(x=x,y=y)) + geom_point(size=.5) + 
 # geom_vline(data=data.frame(CP=true_cps),aes(xintercept=CP),colour="red",linetype="dashed") +
  theme_bw()
```
  \endcol
\endcols

## Change in mean

\begincols
  \begincol{.6\textwidth}
<!-- \footnotesize -->
\scriptsize
```{r,echo=TRUE}
set.seed(14)
m<-5
n<-1000
true_cps <- c(0,sort(sample(1:(n-1),m)),n)
means <- rnorm(m+1,0,4)
y<-c()
for(i in 1:(m+1)){
  j <- (true_cps[i]+1):true_cps[i+1]
  y[j]<-rnorm(length(j),means[i],1)
}

```
  \endcol
\begincol{.4\textwidth}
```{r, fig.height=4,fig.width=3}
ggplot(data.frame(x=1:n,y=y),aes(x=x,y=y)) + geom_point(size=.5) + 
  geom_vline(data=data.frame(CP=true_cps),aes(xintercept=CP),colour="red",linetype="dashed") +
  theme_bw()
```
  \endcol
\endcols

## Change in variance

\begincols
  \begincol{.6\textwidth}
<!-- \footnotesize -->
\scriptsize
```{r,echo=TRUE}
set.seed(12)
m<-5
n<-1000
true_cps <- c(0,sort(sample(1:(n-1),m)),n)
sd <- runif(m+1,1,20)
y<-c()
for(i in 1:(m+1)){
  j <- (true_cps[i]+1):true_cps[i+1]
  y[j]<-rnorm(length(j),0,sd[i])
}

```
  \endcol
\begincol{.4\textwidth}
```{r, fig.height=4,fig.width=3}
ggplot(data.frame(x=1:n,y=y),aes(x=x,y=y)) + geom_point(size=.5) +
  #geom_vline(data=data.frame(CP=true_cps),aes(xintercept=CP),colour="red",linetype="dashed") +
  theme_bw()
```
  \endcol
\endcols


## Change in variance

\begincols
  \begincol{.6\textwidth}
<!-- \footnotesize -->
\scriptsize
```{r,echo=TRUE}
set.seed(12)
m<-5
n<-1000
true_cps <- c(0,sort(sample(1:(n-1),m)),n)
sd <- runif(m+1,1,20)
y<-c()
for(i in 1:(m+1)){
  j <- (true_cps[i]+1):true_cps[i+1]
  y[j]<-rnorm(length(j),0,sd[i])
}

```
  \endcol
\begincol{.4\textwidth}
```{r, fig.height=4,fig.width=3}
ggplot(data.frame(x=1:n,y=y),aes(x=x,y=y)) + geom_point(size=.5) +
  geom_vline(data=data.frame(CP=true_cps),aes(xintercept=CP),colour="red",linetype="dashed") +
  theme_bw()
```
  \endcol
\endcols

## Change in trend

\begincols
  \begincol{.6\textwidth}
<!-- \footnotesize -->
\scriptsize
```{r,echo=TRUE}
set.seed(110)
m<-3
n<-1000
true_cps <- c(0,sort(sample(1:(n-1),m)),n)
slope <- rnorm(m+1,0,.01)
intercept <- rnorm(1,0,1)
y<-c()
for(i in 1:(m+1)){
  j <- (true_cps[i]+1):true_cps[i+1]
  if(i==1){
  for(jind in j){
    y[jind]<-intercept+(jind-true_cps[i])*
      slope[i] + rnorm(1,0,1)
  }
  }else{
    for(jind in j){
      y[jind]<-y[j[1]-1]+(jind-true_cps[i])*
        slope[i] + rnorm(1,0,1)
    }
  }
}

```
  \endcol
\begincol{.4\textwidth}
```{r, fig.height=4,fig.width=3}
ggplot(data.frame(x=1:n,y=y),aes(x=x,y=y)) + geom_point(size=.5) +
  #geom_vline(data=data.frame(CP=true_cps),aes(xintercept=CP),colour="red",linetype="dashed") +
  theme_bw()
```
  \endcol
\endcols

## Change in trend

\begincols
  \begincol{.6\textwidth}
<!-- \footnotesize -->
\scriptsize
```{r,echo=TRUE}
set.seed(110)
m<-3
n<-1000
true_cps <- c(0,sort(sample(1:(n-1),m)),n)
slope <- rnorm(m+1,0,.01)
intercept <- rnorm(1,0,1)
y<-c()
for(i in 1:(m+1)){
  j <- (true_cps[i]+1):true_cps[i+1]
  if(i==1){
  for(jind in j){
    y[jind]<-intercept+(jind-true_cps[i])*
      slope[i] + rnorm(1,0,1)
  }
  }else{
    for(jind in j){
      y[jind]<-y[j[1]-1]+(jind-true_cps[i])*
        slope[i] + rnorm(1,0,1)
    }
  }
}

```
  \endcol
\begincol{.4\textwidth}
```{r, fig.height=4,fig.width=3}
ggplot(data.frame(x=1:n,y=y),aes(x=x,y=y)) + geom_point(size=.5) +
  geom_vline(data=data.frame(CP=true_cps),aes(xintercept=CP),colour="red",linetype="dashed") +
  theme_bw()
```
  \endcol
\endcols

## Real World Examples

\begincols
  \begincol{.4\textwidth}
    \includegraphics[width = 5cm,clip]{copynumber.png} \
    \scriptsize (a) Copy number at genomic positions in a human breast tumor sample (Chen & Wang, 2009). 
  \endcol
  \begincol{.4\textwidth}
       \includegraphics[width = 5cm,clip]{BFM.png} \
  \scriptsize (b) Rotation of a bacterial flagella motor (Maidstone, 2016).
  \endcol
\endcols

## Many changepoint methods

Many different changepoint algorithms exist
\begincols
  \begincol{.4\textwidth}
  
  - Exhaustive Search
  - Optimal Partitioning
  - PELT
  - FPOP (and R-FPOP)
  - CROPS
  - Segment Neighbourhood Search
  - pDPA
  - SNIP
  
\endcol
\begincol{.4\textwidth}

  - Binary Segmentation
  - WBS
  - CBS
  - SMUCE
  - SMOP
  - ED-PELT
  - E-Divisive
  - ECP
  
\endcol
\endcols

## Cost function representation

Most changepoint detection methods boil down to minimising the sum of some cost function, $\mathcal{C}(\cdot)$, over the segments.

\[
\min_{\tau_{1:m},m} \left[\sum_{j=0}^{m+1} \mathcal{C}(\mathbf{y}_{\tau_j+1:\tau_{j+1}})\right]
\]
This cost function could be a number of things:

1. Negative log-likelihood,
2. Negative posterior,
3. Minimum Description Length.

## Dynamic Programming Methods

\begin{description}
\item[Optimal Partitioning:] Optimisation based sum of optimal up to last changepoint and the cost between last changepoint and current time (plus a penalty to avoid over fitting).
\begin{block}{}
\setlength\abovedisplayskip{0pt}
\begin{align*}
F(\tau^*)=\min_{0\leq\tau<\tau^*}[F(\tau)+\mathcal{C}(\mathbf{y}_{(\tau+1):\tau^*})+\beta].
\end{align*}
\end{block}
\item[Segment Neighbourhood Search:] Optimisation for $k$ segments based on optimal for $k-1$ segments plus cost for new segment.
\begin{block}{}
\setlength\abovedisplayskip{0pt}
\begin{align*}
q_{1,j}^k=\min_{v\in \{1,\hdots,j-1\}}[q_{1,v}^{k-1}+q_{v+1,j}^1].
\end{align*}
\end{block}
\end{description}

## Optimal Partitioning using Rigaill's Pruning
\begin{block}{}
\small{
\begin{description}
\item[Input:] A set of data of the form, $(y_1,y_2,\hdots,y_n)$ where $y_i\in\RR$.\\
A measure of fit $\gamma(\cdot,\cdot)$,\\% dependent on the data and the mean,\\
A penalty $\beta$ which does not depend on the number or location of changepoints.
\item[Initialise:] Let $n=$length of data, and set $F(0)=-\beta$, $cp(0)=0$, $LOC=\{0\}$, $D=[\min_{1\leq i\leq n}(y_i),\max_{1\leq i\leq n}(y_i)]$, $Set_{0}=D$, $Cost_0(\mu,0)=F(0)+\beta=0$
\item[Iterate:] for $\tau^*=1,\hdots,n$
\begin{enumerate}
\item Update functions $Cost_{\tau}(\mu,\tau^*)$ for all $\tau\in LOC$.
\item Set $F(\tau^*)=\min_{\tau\in LOC}(\min_{\mu\in Set_{\tau}}[Cost_{\tau}(\mu,\tau^*)])$.
\item Let $\tau'=\operatorname*{arg\,min}_{\tau\in LOC}(\min_{\mu\in Set_{\tau}}[Cost_{\tau}(\mu,\tau^*)])$.
\item Set $Cost_{\tau^*}(\mu,\tau^*)=F(\tau^*)+\beta$ and $Set_{\tau^*}=D$.
\item Set $cp(\tau^*)=(cp(\tau'),\tau')$.
\item Update $LOC$.
\end{enumerate}
\item[Output:] The changepoints recorded in $cp(n)$.
\end{description}}
\end{block}

## refs

- Chen, J., & Wang, Y.-P. (2009). A Statistical Change Point Model Approach for the Detection of DNA Copy Number Variations in Array CGH Data. IEEE/ACM Transactions on Computational Biology and Bioinformatics / IEEE, ACM, 6(4), 529â€“541. http://doi.org/10.1109/TCBB.2008.129





